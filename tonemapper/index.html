<!DOCTYPE html>
<html lang="en-GB" id="hxa7241-tonemapper" class="hxa7241-software">

<head>
   <title>&lt; H X A 7 2 4 1 &gt; : tonemapper</title>
   <meta charset="UTF-8" />

   <link rel="stylesheet" type="text/css" href="../style/hxa7241-main-2016.css" />
</head>

<body>

   <header id="top-head">
      <h1><a href="http://www.hxa.name/"><img src="../style/hxa7241-logo-h.svg" alt="HXA7241" /></a></h1>
      <div id="sub-head"><a href="../#software">software</a></div>
      <div id="subsub-head">various software projects</div>
   </header>

   <main>
      <article class="artefact">

<header class="artefact-head">
<pre><code>"artefact-metadata-hxa7241-www": {
  "title": "P3 Tonemapper",
  "author": "Harrison Ainsworth",
  "date": "2007-06-26",
  "id": "urn:uuid:2F66180A-37CF-4F82-9677-D3F985FC8BA3",
  "type": "article",
  "subtype": "text/html",
  "wordcount": 772,
  "hashsecure": "sha256:267604948059d66f<wbr/>fa23e75badaaaabf<wbr/>94e971758a5c6e5d<wbr/>7357805bf81dcca3",
  "location": "http://www.hxa.name/tonemapper/"
}</code></pre>
</header>

<!-- hash next element -->
<section class="artefact-body">
   <h2>P3 Tonemapper</h2>
   <p class="artefact-summary">a tone-mapper open-source component for high-quality rendering</p>

   <table class="artefact-menu">
      <tr>
         <td>
            <ul>
               <li><a href="#desc">Description</a></li>
               <li><a href="#images">Images</a></li>
               <li><a href="#technique">Technique</a></li>
               <li><a href="#usage">Usage</a></li>
               <li><a href="#downloads">Downloads</a></li>
               <li><a href="#othertools">Others</a></li>
            </ul>
         </td>
      </tr>
   </table>

   <section id="desc">
      <h3>Description</h3>

      <p id="desc-p0">P3 Tonemapper transforms a high-dynamic-range image into a low-dynamic-range image, in an automated way, sensitive to human perception. It produces natural-looking and realistic results.</p>

      <p id="desc-p1">It is in two parts: a <b>command line application</b>, and a <b>dynamic library</b> for programmatic use. Supported platforms are <b>Windows</b> and <b>Linux</b> (and maybe Mac one day).</p>

      <p id="desc-p2">Images are <b>RGB</b>, with exact colorspace specifiable. <b>OpenEXR</b> and <!--<a href="http://radsite.lbl.gov/radiance/">-->Radiance<!--</a>--> <!--<a href="http://radsite.lbl.gov/radiance/refer/filefmts.pdf">-->RGBE<!--</a>--> files are readable, and <b>PNG</b> and <!--<a href="http://netpbm.sourceforge.net/doc/ppm.html">-->PPM<!--</a>--> files are writeable to 16bit precision.</p>

      <p id="desc-p3">The essential algorithm is from <a href="http://radsite.lbl.gov/radiance/papers/lbnl39882/tonemap.pdf" title="A Visibility Matching Tone Reproduction Operator For High Dynamic Range Scenes">📄 &lsquo;A Visibility Matching Tone Reproduction Operator&rsquo; by Ward Larson</a>. It produces good results, accounts for human perceptual limitations, and is highly automatic. Others could be added.</p>

      <p id="desc-p4">Full ISO-98 <b>C++ source code</b> is available, under <b>LGPL</b> license. It is carefully organized, commented, with wide unit-test coverage. Overall high-level <a href="p3-tonemapper-architecture.html">technical design documentation</a> is included.</p>
   </section>


   <section id="images">
      <h3>Images</h3>

      <table class="panel" id="images-p0">
         <tr>
            <td>
               <a href="content/memorial_o876_i.jpg">
                  <img src="memorial_o876_i_small.jpg" width="66" height="100" alt="church interior thumbnail" title="church interior, ideal tonemapping" class="thumbnail" /></a>
               <div class="thumbcaption">Church interior, ideal tone mapping</div>
               <div class="thumbcaption"><small>(63 KiB)</small></div>
            </td>
            <td>
               <a href="content/memorial_o876_h.jpg">
                  <img src="memorial_o876_h_small.jpg" width="66" height="100" alt="church interior thumbnail" title="church interior, human tonemapping showing glare" class="thumbnail" /></a>
               <div class="thumbcaption">Church interior, human tone mapping</div>
               <div class="thumbcaption"><small>(57 KiB)</small></div>
            </td>
            <td>
               <a href="content/tree_oAC1_i.jpg">
                  <img src="tree_oAC1_i_small.jpg" width="102" height="100" alt="tree thumbnail" title="tree, ideal tonemapping" class="thumbnail" /></a>
               <div class="thumbcaption">Tree, ideal tone mapping</div>
               <div class="thumbcaption"><small>(97 KiB)</small></div>
            </td>
            <td>
               <a href="content/tree_oAC1_h.jpg">
                  <img src="tree_oAC1_h_small.jpg" width="102" height="100" alt="tree thumbnail" title="tree, human tonemapping showing glare" class="thumbnail" /></a>
               <div class="thumbcaption">Tree, human tone mapping</div>
               <div class="thumbcaption"><small>(81 KiB)</small></div>
            </td>
         </tr>
      </table>

      <p id="images-p1">The human tone-mappings show the effects of glare: emphasising brightness locally, and reducing contrast more widely.</p>

      <table class="panel" id="images-p2">
         <tr>
            <th colspan="5">Bathroom interior, human tone-mapping, from dark to light in scaling multiples of 10</th>
         </tr>
         <tr>
            <td>
               <a href="content/rend04_o80A_0p1.jpg">
                  <img src="rend04_o80A_0p1_small.jpg" width="68" height="100" alt="bathroom interior thumbnail" title="bathroom interior, human tonemapping 0.1 scaling" class="thumbnail" /></a>
               <div class="thumbcaption"><small>(11 KiB)</small></div>
            </td>
            <td>
               <a href="content/rend04_o80A_1.jpg">
                  <img src="rend04_o80A_1_small.jpg" width="68" height="100" alt="bathroom interior thumbnail" title="bathroom interior, human tonemapping 1 scaling" class="thumbnail" /></a>
               <div class="thumbcaption"><small>(12 KiB)</small></div>
            </td>
            <td>
               <a href="content/rend04_o80A_10.jpg">
                  <img src="rend04_o80A_10_small.jpg" width="68" height="100" alt="bathroom interior thumbnail" title="bathroom interior, human tonemapping 10 scaling" class="thumbnail" /></a>
               <div class="thumbcaption"><small>(15 KiB)</small></div>
            </td>
            <td>
               <a href="content/rend04_o80A_100.jpg">
                  <img src="rend04_o80A_100_small.jpg" width="68" height="100" alt="bathroom interior thumbnail" title="bathroom interior, human tonemapping 100 scaling" class="thumbnail" /></a>
               <div class="thumbcaption"><small>(19 KiB)</small></div>
            </td>
            <td>
               <a href="content/rend04_o80A_1000.jpg">
                  <img src="rend04_o80A_1000_small.jpg" width="68" height="100" alt="bathroom interior thumbnail" title="bathroom interior, human tonemapping 1000 scaling" class="thumbnail" /></a>
               <div class="thumbcaption"><small>(26 KiB)</small></div>
            </td>
         </tr>
      </table>

      <p id="images-p3">These show the effects of darkness: reducing spatial acuity, color sensitivity and contrast sensitivity.</p>

      <p id="images-p4">HDR source images from <a href="http://www.anyhere.com/gward/hdrenc/pages/originals.html">Greg Ward Larson</a>.</p>

      <p id="images-p5" class="panel"><img src="cornell-box-tonemaps.jpg" alt="Cornell Box at four brightnesses with human tone-maps" style="width:100%;"/></p>

      <p id="images-p6">... and a Cornell Box across a range of brightness with human tone-maps.</p>
   </section>


   <section id="technique">
      <h3>Technique</h3>

      <h4 id="technique.core">core</h4>
      <p id="technique.core-p0">Humans judge brightness mostly comparatively. This allows flexibility in squashing real luminance ranges into display images. The <a href="http://radsite.lbl.gov/radiance/papers/lbnl39882/tonemap.pdf" title="A Visibility Matching Tone Reproduction Operator For High Dynamic Range Scenes">Ward Larson</a> technique uses a histogram to do this. One range is squashed into the other, but different sub-ranges are squashed differently, according to population in the original image.</p>

      <p id="technique.core-p1">A histogram of the original image brightness is made, then integrated. The resulting graph is a mapping of original brightness (x axis) to display brightness (y axis). Sub-ranges of luminance that have more representation in the original produce a larger gradient in the graph, so occupy a larger sub-range of display values.</p>

      <p id="technique.core-p2">It follows human vision in adapting to the most popular light level, while still covering much of the rest.</p>

      <h4 id="technique.perceptual">perceptual</h4>
      <h5>glare</h5>
      <p id="technique.perceptual-p0">(bloom not flare) Eye materials scatter a small proportion of light widely over the sensors. This is simulated with a very wide weak filter. The result is reduced contrast overall, and obvious spreading of bright areas onto darker areas.</p>

      <h5>contrast sensitivity</h5>
      <p id="technique.perceptual-p1">Absolute brightness differences are less visible in darkness. This is simulated by clamping the histogram according to luminance. The result is a more gloomy image.</p>

      <h5>color sensitivity</h5>
      <p id="technique.perceptual-p2">Color is less visible in darkness. This is simulated by interpolating pixel values to grey according to luminance. The result is a desaturated/mono image.</p>

      <h5>spatial acuity</h5>
      <p id="technique.perceptual-p3">Sharpness is reduced in darkness. This is simulated by locally filtering according to luminance. The result is a blurry image.</p>
   </section>


   <section id="usage">
      <h3>Usage</h3>

      <h4 id="usage.application">application</h4>
      <p id="usage.application-p0">The general form is:</p>
      <blockquote class="panel"><p><kbd>p3tonemapper [options] [-x:CommandFilePathName] imageFilePathName</kbd></p></blockquote>

      <p id="usage.application-p1">The simplest example ignores human perceptual limitations, and produces consistently good results:</p>
      <blockquote class="panel"><p><kbd>p3tonemapper somerendering.exr</kbd></p></blockquote>

      <p id="usage.application-p2">The next simplest simulates all human limitations, but requires that the input image holds proper cd/m<sup>2</sup> luminance values (or includes a calibrating scale factor). A scale factor can be given with the <kbd>-is</kbd> option:</p>
      <blockquote class="panel"><p><kbd>p3tonemapper -m1:h -is:1000_0 anotherimage.hdr</kbd></p></blockquote>

      <p id="usage.application-p3">There are options to control:</p>
      <ul id="usage.application-p4">
         <li>input RGB chromaticities</li>
         <li>input pixel scaling and offset</li>
         <li>input view frustrum angle</li>
         <li>glare and acuity and color sensitivity on/off</li>
         <li>output display luminance range</li>
         <li>output gamma transform</li>
         <li>output bit depth</li>
      </ul>

      <p id="usage.application-p5">Dynamic libraries for <a href="http://www.openexr.com/">OpenEXR</a> and <a href="http://www.libpng.org/pub/png/">PNG</a> must be present to use those formats.</p>

      <h4 id="usage.library">library</h4>

      <p id="usage.library-p0">The library has a <a href="p3tmPerceptualMap.h.html">C interface</a> defined in two header files. For Windows, there is an import library to link with, or it can be accessed purely dynamically.</p>

      <p id="usage.library-p1">The core interface follows an object pattern, in three parts: construction and destruction, commands to set options, and queries to operate on data. Overlayed on that is a simpler, more typed, interface, so an image may be tonemapped with a single function call.</p>

      <p id="usage.library-p2">Currently it takes the HDR image as an array of float triples, and writes the tonemapped image to an array of byte or word triples.</p>
   </section>


   <section id="downloads">
      <h3>Downloads</h3>

      <p id="downloads-p0">Version 1.2 (2007-06-26)</p>

      <table class="panel" id="downloads-p1">
         <tr>
            <td>
               💻
               <a href="p3tonemapper12exe-win.zip" onclick="javascript:urchinTracker('/tonemapper/tonemapper-download');">p3tonemapper12exe-win.zip</a>
            </td>
            <td class="tableitem">application and library - Windows (199 KiB)</td>
         </tr>
         <tr>
            <td>
               🐧
               <a href="p3tonemapper12exe-linux.tar.gz" onclick="javascript:urchinTracker('/tonemapper/tonemapper-download');">p3tonemapper12exe-linux.tar.gz</a>
            </td>
            <td class="tableitem">application and library - Linux (x86) (102 KiB)</td>
         </tr>
         <tr>
            <td>
               📦
               <a href="p3tonemapper12src.zip" onclick="javascript:urchinTracker('/tonemapper/tonemapper-download');">p3tonemapper12src.zip</a>
            </td>
            <td class="tableitem">source code (266 KiB)</td>
         </tr>
      </table>
   </section>


   <section id="othertools">
      <h3>Others</h3>

      <p id="othertools-p0">Related open-source tools:</p>
      <ul id="othertools-p1">
         <li><a href="http://www.mpi-inf.mpg.de/resources/pfstools/">PFSTools</a> &mdash; various HDR formats, several tone mappers</li>
         <li><a href="http://scanline.ca/exrtools/">exrtools</a> &mdash;  OpenEXR images, a few tone mappers</li>
      </ul>
   </section>

</section>

      </article>
   </main>

</body>

</html>
